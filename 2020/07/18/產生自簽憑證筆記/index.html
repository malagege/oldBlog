<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-tw">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="cert,">










<meta name="description" content="上次上班花很多時間處理憑證問題為了碰到下次不要花費太多時間設備根憑證不正確導致不能打API問題 | 程式狂想筆記今天要還債(技術債)了主要試試看建立憑證">
<meta name="keywords" content="cert">
<meta property="og:type" content="article">
<meta property="og:title" content="產生自簽憑證筆記">
<meta property="og:url" content="https://malagege.github.io/blog/2020/07/18/產生自簽憑證筆記/index.html">
<meta property="og:site_name" content="程式狂想筆記">
<meta property="og:description" content="上次上班花很多時間處理憑證問題為了碰到下次不要花費太多時間設備根憑證不正確導致不能打API問題 | 程式狂想筆記今天要還債(技術債)了主要試試看建立憑證">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://malagege.github.io/blog/2020/07/14/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png">
<meta property="og:updated_time" content="2020-07-22T12:43:59.762Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="產生自簽憑證筆記">
<meta name="twitter:description" content="上次上班花很多時間處理憑證問題為了碰到下次不要花費太多時間設備根憑證不正確導致不能打API問題 | 程式狂想筆記今天要還債(技術債)了主要試試看建立憑證">
<meta name="twitter:image" content="https://malagege.github.io/blog/2020/07/14/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://malagege.github.io/blog/2020/07/18/產生自簽憑證筆記/">





  <title>產生自簽憑證筆記 | 程式狂想筆記</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-105195903-2', 'auto');
  ga('send', 'pageview');
</script>






  <!-- Google AdSense start -->
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1439458814178865",
    enable_page_level_ads: true
  });
</script>

  <!-- Google AdSense end -->
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-tw">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">程式狂想筆記</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一個攻城師奮鬥史</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/blog/links/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br>
            
            好站連結
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            檢索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://malagege.github.io/blog/blog/2020/07/18/產生自簽憑證筆記/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="malagege">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式狂想筆記">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">產生自簽憑證筆記</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2020-07-18T17:37:51+08:00">
                2020-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2020/07/18/產生自簽憑證筆記/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/07/18/產生自簽憑證筆記/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
        <div align="center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-1439458814178865" data-ad-slot="2236653478"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

        <p>上次上班花很多時間處理憑證問題<br>為了碰到下次不要花費太多時間<a href="https://malagege.github.io/blog/2020/07/14/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/">設備根憑證不正確導致不能打API問題 | 程式狂想筆記</a><br>今天要還債(技術債)了<br>主要試試看建立憑證</p>
<a id="more"></a>
<h2 id="建立根憑證"><a href="#建立根憑證" class="headerlink" title="建立根憑證"></a>建立根憑證</h2><p>這邊範例是照<a href="https://blog.miniasp.com/post/2019/02/25/Creating-Self-signed-Certificate-using-OpenSSL?fbclid=IwAR3xS1xqkOfLQmK22bDyp9bgOJ71PBNChr-2REMq3oIMT5-0biUTJl41a1k" target="_blank" rel="noopener">如何使用 OpenSSL 建立開發測試用途的自簽憑證 (Self-Signed Certificate) | The Will Will Web</a><br>可以找個 VM 來測試看環境</p>
<ol>
<li>安裝 openssl</li>
</ol>
<p>ubuntu 預設就會安裝</p>
<ol start="2">
<li>設定 conf </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[req]</span><br><span class="line">prompt = no</span><br><span class="line">default_md = sha256</span><br><span class="line">default_bits = 2048</span><br><span class="line">distinguished_name = dn</span><br><span class="line">x509_extensions = v3_req</span><br><span class="line"></span><br><span class="line">[dn]</span><br><span class="line">C = TW</span><br><span class="line">ST = Taiwan</span><br><span class="line">L = Taipei</span><br><span class="line">O = Duotify Inc.</span><br><span class="line">OU = IT Department</span><br><span class="line">emailAddress = admin@example.com</span><br><span class="line">CN = localhost</span><br><span class="line"></span><br><span class="line">[v3_req]</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = *.localhost</span><br><span class="line">DNS.2 = localhost</span><br><span class="line">IP.1 = 192.168.2.100</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>產生私鑰、公鑰</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -new -nodes -sha256 -utf8 -days 3650 -newkey rsa:2048 -keyout server.key -out server.crt -config ssl.conf</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>丟到系統憑證區</li>
</ol>
<p>Ubuntu </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp server.crt /usr/<span class="built_in">local</span>/share/ca-certificates/</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>測試結果<br>沒錯，就這麼簡單<br>可以找一個隨便 Web Server 建立</li>
</ol>
<p>這邊我用的是 Apache 安裝<br>這邊小卡了一下，因為我是第一次設定XD</p>
<p>啟用 ssl 模組<br>a2enmod ssl<br>啟用 ssl 虛擬站台<br>a2ensite default-ssl<br>重啟 apache<br>sudo service apache2 restart<br>修改憑證路徑(private.key,public.crt/pem)<br>vim /etc/apache2/sites-enabled/default-ssl.conf </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SSLCertificateFile      /home/vagrant/server.crt</span><br><span class="line">SSLCertificateKeyFile /home/vagrant/server.key</span><br></pre></td></tr></table></figure>
<p>就可以測試結果了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl https://localhost</span><br><span class="line"><span class="comment"># ok</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span>|openssl s_client  -connect localhost:443 2&gt;&amp;1  | less</span><br><span class="line"><span class="comment"># 會有Can't use SSL_get_servername</span></span><br><span class="line"><span class="comment"># 不過還是過了，verify return:1 </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span>|openssl s_client -servername localhost -connect localhost:443 2&gt;&amp;1  | less</span><br><span class="line"><span class="comment"># 就不會有這個問題 Can't use SSL_get_servername</span></span><br></pre></td></tr></table></figure>
<p>相關教學</p>
<p><a href="https://www.ichiayi.com/wiki/tech/openssl_caserver" target="_blank" rel="noopener">OpenSSL 簽發憑證方式 [蔡宗融個人網站]</a><br>使用這個做，會有<code>[Sat Jul 18 11:12:43.084807 2020] [ssl:emerg] [pid 27557:tid 140210043268160] SSL Library Error: error:140AB18E:SSL routines:SSL_CTX_use_certificate:ca md too weak
AH00016: Configuration Failed</code><br>後來參考:<a href="http://blog.itist.tw/2014/06/openssl.html" target="_blank" rel="noopener">Raspberry Pi 的實作 - 產生一張自己核發的 SSL 憑證 | IT 技術家</a><br>使用1024會有ee key too small<br><a href="https://www.cnblogs.com/stronger-xsw/p/12760904.html" target="_blank" rel="noopener">nginx:SSL: error:140AB18F:SSL routines:SSL_CTX_use_certificate:ee key too small - 八戒vs - 博客园</a><br>改成 2048 就可以</p>
<p>原本我根憑證想簽下面憑證，產生出來設定在Apache<br>竟然都失敗了<br>這時候我突然想到，每一張都可以簽，不就沒有管理機制?</p>
<blockquote>
<p>其他欄位比較重要的是basic constraints的CA:true和key usage的key cert sign，表示這個憑證可以再往下簽（總不可能讓它無限簽吧）。<br>參考來源:<a href="http://qbsuranalang.blogspot.com/2017/05/openssl-certificate-chain-included-san.html" target="_blank" rel="noopener">TU的雜七雜八筆記本: OpenSSL Certificate Chain (included SAN)</a></p>
</blockquote>
<p><a href="https://blog.toright.com/posts/4024/haproxy-%E6%95%B4%E5%90%88-ssltls-client-certificate-%E6%95%99%E5%AD%B8.html" target="_blank" rel="noopener">HAProxy 整合 SSL/TLS Client Certificate 教學 - Soul &amp; Shell Blog</a><br>這邊沒有提到CA:true</p>
<p>回頭看我產出來的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -noout -text -<span class="keyword">in</span> server.crt</span><br></pre></td></tr></table></figure></p>
<p>真的沒有CA:true</p>
<p>我 Google 到這篇<a href="https://blog.davy.tw/posts/use-openssl-to-sign-intermediate-ca/" target="_blank" rel="noopener">如何使用 OpenSSL 簽發中介 CA</a><br>照他的產生 Root CA 步驟結果有看到 CA:true<br>估計是保哥使用<code>x509_extensions = v3_req</code>關係<br>所以沒有開到 CA:true</p>
<h2 id="產生中繼憑證"><a href="#產生中繼憑證" class="headerlink" title="產生中繼憑證"></a>產生中繼憑證</h2><h3 id="產生授權根憑證"><a href="#產生授權根憑證" class="headerlink" title="產生授權根憑證"></a>產生授權根憑證</h3><p><a href="https://blog.davy.tw/posts/use-openssl-to-sign-intermediate-ca/" target="_blank" rel="noopener">如何使用 OpenSSL 簽發中介 CA</a><a href="/blog/2020/07/18/產生自簽憑證筆記/web2.png" title="備份圖">備份圖</a></p>
<blockquote>
<p>建立 Key 應該是整個環節中最簡單的步驟了，利用簡單的 openssl genrsa 即可，這邊採用 AES256 加密 Key 並將長度設為 4096（如果你不想要加上密碼，就不要下 -aes256，但你的 Key 就少了一層保護）：</p>
</blockquote>
<p>我不想打密碼就拿掉了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa  -out ca.key 4096</span><br></pre></td></tr></table></figure>
<p>相關資訊打完(備註: CN 我打 localhost)<br>複製到系統安全憑證區</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ca.pem /usr/<span class="built_in">local</span>/share/ca-certificates/ca.srt  <span class="comment"># 這邊要改成srt</span></span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure>
<p>openssl x509 -noout -text -in ca.pem<br>確實有看到 CA: true<br>先到 Apache 測試 <a href="https://localhost" target="_blank" rel="noopener">https://localhost</a><br>curl 成功</p>
<h3 id="產生中繼憑證-1"><a href="#產生中繼憑證-1" class="headerlink" title="產生中繼憑證"></a>產生中繼憑證</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa  -out intermediate.key 4096</span><br></pre></td></tr></table></figure>
<p>一樣我AES256拿掉<br><del>我就是不想打密碼，我就爛XD</del></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CN 我設定 a.localhost 網域</span></span><br><span class="line">openssl req -sha256 -new -key intermediate.key -out intermediate.csr</span><br><span class="line">vim intermediate.ext</span><br></pre></td></tr></table></figure>
<p>intermediate.ext內容貼上去<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ intermediate_ca ]</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid:always,issuer</span><br><span class="line">basicConstraints = CA:true, pathlen:0</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>為什麼要自己定義呢？ 用原本的 v3_ca 不好嗎？<br>當然，如果你想要讓這個 CA 跟 Root CA 一樣可以繼續往下簽 Intermediate CA 的話，那你可以選擇繼續使用 v3_ca。<br>上面定義的 intermediate_ca 相較預設的 v3_ca 多了一個 pathlen:0，表示他往下還可以有 0 個 Intermediate CA（也就是沒有的意思）。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -in intermediate.csr \</span><br><span class="line">               -CA ca.pem -CAkey ca.key \</span><br><span class="line">               -CAserial ca.serial -CAcreateserial \</span><br><span class="line">               -days 730 \</span><br><span class="line">               -extensions intermediate_ca -extfile intermediate.ext \</span><br><span class="line">               -out intermediate.pem</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其中有幾個選項需要介紹一下：</p>
<p>   -CAserial ca.serial： 每個 CA 簽發憑證時都需要一個流水號，這裡是指出流水號記錄檔檔名<br>   <strong>-CAcreateserial： 只有當 CA 初次簽發時需要，他會初始化一個流水號出來，第二次之後簽發就不要帶這個參數，以免流水號被重置</strong><br>   -extensions intermediate_ca： 我們想要指定剛剛我們建立的 extension<br>   -extfile intermediate.ext： 需要指定包含 extension 的設定檔</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看中繼憑證</span></span><br><span class="line">openssl x509 -noout -text -<span class="keyword">in</span> intermediate.pem</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到 Issuer 是我們 Root CA 的名稱，而 Subject 是 CSR 中填寫的內容。<br>並且有將 pathlen 設為 0，表示這個 CA 只能用來簽發終端憑證。</p>
</blockquote>
<blockquote>
<p>另外，我們還可以透過 openssl verify 驗證這個憑證是不是由 Root CA 一路發下來的。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl verify -CAfile ca.pem intermediate.pem</span><br><span class="line"><span class="comment"># intermediate.pem: OK</span></span><br></pre></td></tr></table></figure>
<p>一樣我把中繼憑證複製到 Apache 測試 <a href="https://a.localhost" target="_blank" rel="noopener">https://a.localhost</a> OK(更換憑證設定我就不寫了)</p>
<h3 id="產生終端憑證"><a href="#產生終端憑證" class="headerlink" title="產生終端憑證"></a>產生終端憑證</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -aes256 拿掉，不解釋</span></span><br><span class="line">openssl genrsa  -out endentity.key 4096</span><br><span class="line"><span class="comment"># 這次我 CN = a.a.localhost</span></span><br><span class="line">openssl req -sha256 -new -key endentity.key -out endentity.csr</span><br><span class="line"><span class="comment"># 中繼憑證簽發終端憑證</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> endentity.csr \</span><br><span class="line">               -CA intermediate.pem -CAkey intermediate.key \</span><br><span class="line">               -CAserial intermediate.serial -CAcreateserial \</span><br><span class="line">               -days 365 \</span><br><span class="line">               -out endentity.pem</span><br><span class="line"><span class="comment"># 查看憑證</span></span><br><span class="line">openssl x509 -noout -text -<span class="keyword">in</span> endentity.pem</span><br><span class="line"><span class="comment"># 檢查憑證鍊</span></span><br><span class="line">openssl verify -CAfile ca.pem -untrusted intermediate.pem endentity.pem</span><br></pre></td></tr></table></figure>
<p>這邊因為有 Apache/nginx 中繼憑證<br>所以在設定上會不太一樣<br>Apache 有特別設定方法，這邊就不仔細說原因了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SSLCertificateFile      /home/vagrant/test/endentity.pem</span><br><span class="line">SSLCertificateKeyFile /home/vagrant/test/endentity.key</span><br><span class="line">SSLCertificateChainFile /home/vagrant/test/intermediate.pem</span><br></pre></td></tr></table></figure>
<p>Nginx/Apache 都可以把中繼憑證包在一起</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat endentity.pem &gt; web.crt</span></span><br><span class="line"><span class="comment"># cat intermediate.pem &gt;&gt; web.crt</span></span><br><span class="line">cat endentity.pem intermediate.pem &gt; web.crt</span><br></pre></td></tr></table></figure>
<p>Apache 設定<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SSLCertificateFile      /home/vagrant/test/web.crt</span><br><span class="line">SSLCertificateKeyFile /home/vagrant/test/endentity.key</span><br><span class="line">#SSLCertificateChainFile /home/vagrant/test/intermediate.pem</span><br></pre></td></tr></table></figure></p>
<p>curl <a href="https://a.a.localhost/" target="_blank" rel="noopener">https://a.a.localhost/</a> 顯示正常</p>
<h2 id="wildcard"><a href="#wildcard" class="headerlink" title="wildcard"></a>wildcard</h2><p>以下教學使用<a href="https://blog.darkthread.net/blog/issue-wildcard-ssl-cert-with-openssl/" target="_blank" rel="noopener">使用 OpenSSL 製作萬用字元 SSL 憑證-黑暗執行緒</a></p>
<blockquote>
<p>2017 年 Chrome 58 / Firefox 48 開始要求憑證必須改用 SubjectAltName 欄位提供主機名稱 ，否則將顯示為不安全</p>
</blockquote>
<p>========= 犯錯區 Start =========</p>
<p><strong>這邊修改 *.localhost,*.*.localhost,*.*.*.localhost 網域</strong></p>
<p>這邊後續我有繼續做，一直失敗，差點要放棄<br>過程是這樣的</p>
<ol>
<li>我把localhost-ext.cnf 把 *.localhost 單獨一個<br>結果失敗了</li>
<li>我把 SNA 只留 *.localhost<br>還是失敗了</li>
<li>我把 SNA 放 *.localhost, localhost<br>也是失敗了</li>
<li><p>我把 Apache conf 設定家 Servername localhost Serveralias localhost *.localhost<br>還是失敗了</p>
</li>
<li><p>…<br><a href="https://www.devside.net/wamp-server/generating-and-installing-wildcard-and-multi-domain-ssl-certificates" target="_blank" rel="noopener">Generating and Installing Wildcard and Multi-Domain SSL Certificates | DeveloperSide.NET</a></p>
</li>
</ol>
<p>openssl verify -CAfile ca.pem -untrusted intermediate.pem localhost.crt<br>這一段沒有錯，但還是跑出這個錯誤<br>curl -v <a href="https://a.a.localhost" target="_blank" rel="noopener">https://a.a.localhost</a></p>
<ul>
<li>subjectAltName does not match a.a.localhost</li>
<li>SSL: no alternative certificate subject name matches target host name ‘a.a.localhost’<br>跟別的網站不一樣</li>
<li>subjectAltName: host “xxx.xxxxx.com.tw” matched cert’s “*.xxxxx.com.tw”</li>
</ul>
<p>apache error log<br>AH01909: 127.0.1.1:443:0 server certificate does NOT include an ID which matches the server name</p>
<blockquote>
<p> 後來求助偉大的谷歌，發現原來是nginx的TLS SNI support功能沒開，SNI （服務器名字指示）不開啟的話，一個IP只支持一個SSL證書，不支持多個證書，而服務器是yum安裝的nginx，默認TLS SNI support是關閉的，重新編譯nginx並指定openssl庫後，TLS SNI support 開啟了，訪問就正常了<br><a href="https://blog.51cto.com/czwanga/1925013" target="_blank" rel="noopener">記錄一次升級https走過的坑-czwanga-51CTO博客</a></p>
</blockquote>
<p>…<br>….<br>…..</p>
<p><del>總之努力不一定會成功，不努力就一定很輕鬆</del><br><del>各位 Bye</del><br>剛好最近看到<a href="https://www.youtube.com/watch?v=AlOO2yb4q2M&amp;feature=youtu.be&amp;t=236" target="_blank" rel="noopener">【Fun科學】靈壓探測器(潛伏身邊的不明危機！) - YouTube</a></p>
<p>為了不浪費大家的時間，我最後解決了，整理一下發生了什麼原因</p>
<p><del>這邊修改 *.localhost,*.*.localhost,*.*.*.localhost 網域</del><br>這邊我犯了很嚴重錯誤<br>這邊萬用網域也不是可以隨便用網址<br>需要使用<strong>一級網域</strong>做萬用憑證 EX:*.localhost.com  &lt;==== 這邊<strong>一級網域</strong>應該是指 萬用憑證 不是只 SNA<br>萬用憑證也只能用一層，所以*.*.localhost.com,*.*.*.localhost.com (應該不行，我沒有實驗)<br>正確來說 現在萬用憑證不看 CN 了，現在瀏覽器都會看 SNA 是否正確<br>SNA 算是 憑證 x509 插件<br>有實驗 *.a.localhost.com 是可以跑了</p>
<p>因為 localhost.com 網域 DNS 會抓不到<br>所以我們先手動設定 /etc/hosts 設定 127.0.0.1  localhost.com<br>家如要新增 a.localhost.com 也要獨立新增 127.0.0.1 a.localhost.com<br>SNA 也能設定 *.a.localhost.com ，沒有一級網域限制</p>
<p>以上是我實驗結果</p>
<p>參考資料</p>
<ul>
<li><a href="http://liaoph.com/openssl-san/" target="_blank" rel="noopener">OpenSSL SAN 证书 - Fantasy</a><br>這邊裡面有介紹 SNA</li>
</ul>
<blockquote>
<p>萬用字元憑證只能覆蓋一級子域<br><a href="https://zh.wikipedia.org/wiki/%E9%80%9A%E9%85%8D%E7%AC%A6%E8%AF%81%E4%B9%A6" target="_blank" rel="noopener">萬用字元憑證 - 維基百科，自由的百科全書</a></p>
</blockquote>
<blockquote>
<p>   Wildcard Domains: Wildcard domains such as <em>.example.com are useful when protecting multiple services on one domain such as <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a>, mail.example.com, mx.example.com, ftp.example.com, blog.example.com, etc. however it has several limitations:<br>       Non-zero length subdomain: first is that many sites will use a combination of <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a> and example.com and a </em>.example.com wildcard will not match the latter.<br>       Only flat subdomain support: wildcards will not support multiple subdomains, for example <em>.m.example.com will not be matched by </em>.example.com.<br>       Only one domain: finally, *.example.com will not support an entirely different subdomain such as foobar.com<br>   Subject Alternative Name: Using the X.509 subjectAltName extension has been useful to address some of the limiations of wildcard domains, namely they can contain multiple FQDNs of all types so names with differing numbers of subdomains and entirely different domains can be suppored. To make SANs even more useful, the goal of this effort was to validate the support for using wildcard domain names in the SAN.<br>參考來源:<a href="https://grokify.github.io/security/wildcard-subject-alternative-name-ssl-tls-certificates/" target="_blank" rel="noopener">Wildcard Subject Alternate Name SSL/TLS Certificates</a></p>
</blockquote>
<p>========= 犯錯區 End =========</p>
<p>這邊拿剛剛上面中繼憑證繼續用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建立私鑰</span></span><br><span class="line">openssl genrsa -out localhost.key 2048</span><br><span class="line"><span class="comment"># 設定 localhost.cnf</span></span><br><span class="line">vim localhost.cnf</span><br></pre></td></tr></table></figure>
<p>localhost.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[req]</span><br><span class="line">default_bits = 2048</span><br><span class="line">prompt = no</span><br><span class="line">default_md = sha256</span><br><span class="line">distinguished_name = dn</span><br><span class="line"></span><br><span class="line">[dn]</span><br><span class="line">C=TW</span><br><span class="line">ST=Taiwan</span><br><span class="line">L=Taipei</span><br><span class="line">O=localhost</span><br><span class="line">OU=localhost CA</span><br><span class="line">emailAddress=nobody@localhost</span><br><span class="line">CN=*.localhost.com</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 產出 CSR</span></span><br><span class="line">openssl req -new -sha256 -nodes -key localhost.key -out localhost.csr -config localhost.cnf</span><br><span class="line"></span><br><span class="line">vim localhost-v3.cnf</span><br></pre></td></tr></table></figure>
<p>localhost-v3.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">keyUsage                = critical,digitalSignature,keyEncipherment</span><br><span class="line">extendedKeyUsage        = serverAuth,clientAuth</span><br><span class="line">subjectKeyIdentifier    = hash</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = *.localhost.com</span><br><span class="line">DNS.2 = localhost.com</span><br><span class="line">DNS.3 = *.a.localhost.com</span><br></pre></td></tr></table></figure></p>
<p>這邊因為中途失敗一直嘗試更改，所以跟darkthread-net-v3.ext 不太一樣</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; authorityKeyIdentifier=keyid,issuer</span><br><span class="line">&gt; basicConstraints=CA:FALSE</span><br><span class="line">&gt; keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">&gt; subjectAltName = @alt_names</span><br><span class="line">&gt; </span><br><span class="line">&gt; [alt_names]</span><br><span class="line">&gt; DNS.1 = *.darkthread.net</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  拿掉 -CAcreateserial</span></span><br><span class="line"><span class="comment">#  -CAserial intermediate.serial 需要指定序號，後面參數指的是序號檔名</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> localhost.csr -CA intermediate.pem -CAkey intermediate.key  -out localhost.crt -days 365 -sha256 -CAserial intermediate.serial -extfile localhost-v3.ext</span><br></pre></td></tr></table></figure>
<p>基本上放在 Apache 之前設定跟之前差不多<br>我就不說了</p>
<p><a href="https://a.localhost.com" target="_blank" rel="noopener">https://a.localhost.com</a><br><a href="https://a.a.localhost.com" target="_blank" rel="noopener">https://a.a.localhost.com</a></p>
<p>curl 都可以順利跑</p>
<h2 id="TWCA-憑證為什麼有三層，四層串到同一個憑證呢"><a href="#TWCA-憑證為什麼有三層，四層串到同一個憑證呢" class="headerlink" title="TWCA 憑證為什麼有三層，四層串到同一個憑證呢?"></a>TWCA 憑證為什麼有三層，四層串到同一個憑證呢?</h2><p>我目前猜想其中兩邊憑證都是吃同一把私鑰<br>產生兩組 crt(public key)<br>所以憑證都可以用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> intermediate.csr \</span><br><span class="line">               -CA ca.pem -CAkey ca.key \</span><br><span class="line">               -CAserial ca.serial \</span><br><span class="line">               -days 730 \</span><br><span class="line">               -extensions intermediate_ca -extfile intermediate.ext \</span><br><span class="line">               -out intermediate2.pem</span><br></pre></td></tr></table></figure>
<p><strong>2020-07-22</strong><br>最後這篇有和我同學討論<br><img src="https://malagege.github.io/blog/2020/07/14/%E8%A8%AD%E5%82%99%E6%A0%B9%E6%86%91%E8%AD%89%E4%B8%8D%E6%AD%A3%E7%A2%BA%E5%B0%8E%E8%87%B4%E4%B8%8D%E8%83%BD%E6%89%93API%E5%95%8F%E9%A1%8C/cgh.png" alt=""><br>我認為跟用同一個私金鑰產生有關係<br>他認為公鑰解析出來應該跟 pin sha256 一樣有關係 (當時看圖片沒注意到)<br>不過我們加密學都不是很懂，這邊就不繼續研究了</p>
<p>至於抓兩個路徑<br>我目前猜測四層憑證第二層對應上去都是 TWCA Global Root CA<br>除了中繼憑證跟電腦跟憑證 Mapping 到名子對應上去剛好符合驗證解密內容<br>四層憑證在 Windows 看是四層，但用在 Firefox,Linux(Chrome),Android(Chrome) 來看竟然是抓到三層</p>
<p>總結心得<br>當出現網站不安全，都是無法串連(client)<strong>根憑證</strong>有關係<br>根憑證正確就往下追中繼憑證，中繼憑證順序都需要注意<br>中繼憑證可以不用附根憑證(畢竟裝置有根憑證，沒必要再傳送過去)<br>但我這個案例比較特別，正常應該不會遇到<br>裝置有兩個 TWCA 根憑證，正常應該不會遇到問題<br>就算裝置有三層根憑證，也通吃<br>但是裝置只有四層根憑證，就會出現不安全!!!(像 LINE Webhook 就沒有 TWCA 三層憑證)<br>不過還是看到滿多網站都掛四層憑證居多<br>可以到很多銀行、醫院網站看看憑證</p>
<p>把 apache 設定 endentity.pem 對應 intermediate2.pem 真得可以用</p>
<h2 id="測試檔案"><a href="#測試檔案" class="headerlink" title="測試檔案"></a>測試檔案</h2><a href="/blog/2020/07/18/產生自簽憑證筆記/test_cert.7z" title="所有範例下載">所有範例下載</a>
<p>/vagrant/ &lt;====== 第一段建立憑證範例<br>/vagrant/test/ &lt;====== 第二、三段建立中繼、萬用憑證範例<br>   hosts 參考 dns 設定檔<br>   default-ssl.conf apache 設定檔</p>
<h2 id="查看-web-上驗憑證內容"><a href="#查看-web-上驗憑證內容" class="headerlink" title="查看 web 上驗憑證內容"></a>查看 web 上驗憑證內容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client  -connect localhost.com:443 &lt;/dev/null  |  openssl x509 -noout -text  | less</span><br><span class="line"></span><br><span class="line">openssl s_client  -connect youtube.com:443 &lt;/dev/null  |  openssl x509 -noout -text  | less</span><br></pre></td></tr></table></figure>
<h2 id="其他資源"><a href="#其他資源" class="headerlink" title="其他資源"></a>其他資源</h2><ul>
<li><p><a href="https://dotblogs.com.tw/grayyin/2019/05/04/143637" target="_blank" rel="noopener">Java keytool 基本指令 | 阿輝的零碎筆記 - 點部落</a></p>
</li>
<li><p><a href="https://code.yidas.com/tls-ssl-certificate-guide/" target="_blank" rel="noopener">[Server] TLS/SSL憑證(Certificate)常用指令 – 製作CSR – YIDAS Code</a></p>
</li>
<li><p><a href="https://xenby.com/b/205-%E6%8E%A8%E8%96%A6-%E5%BF%AB%E9%80%9F%E7%94%A2%E7%94%9F%E6%9C%AC%E5%9C%B0%E7%AB%AF%E9%96%8B%E7%99%BC%E7%94%A8ssl%E6%86%91%E8%AD%89%E5%B7%A5%E5%85%B7-mkcert" target="_blank" rel="noopener">[推薦] 快速產生本地端開發用SSL憑證工具-mkcert | 辛比誌</a></p>
</li>
<li><p><a href="https://blog.pichuang.com.tw/20200204-homelcloud-high-level-design-5/" target="_blank" rel="noopener">2020 大改造宅宅雲架構系列文-5 窮人版 PKI - Phil Workspace</a> <a href="/blog/2020/07/18/產生自簽憑證筆記/web2.png" title="備份圖">備份圖</a><br>裡面有提到 CRL</p>
</li>
<li><p><a href="https://raix852.github.io/2016/06/20/use-openssl-generate-certificate/" target="_blank" rel="noopener">使用 Openssl 建立憑證 | Raix’s Blog</a> <a href="/blog/2020/07/18/產生自簽憑證筆記/web3.png" title="備份圖">備份圖</a><br>這邊也有提到 CRL</p>
</li>
<li><p><a href="https://www.cnblogs.com/charlieroro/p/10948173.html" target="_blank" rel="noopener">rfc 5280 X.509 PKI 解析 - charlieroro - 博客园</a></p>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/cert/" rel="tag"># cert</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2020/07/15/監控多個網頁腳本-Shell/" rel="next" title="監控多個網頁腳本(Shell)">
                <i class="fa fa-chevron-left"></i> 監控多個網頁腳本(Shell)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2020/07/19/Shell-檢查-txt-和-總數確認檔方法/" rel="prev" title="Shell 檢查 txt 和 總數確認檔方法">
                Shell 檢查 txt 和 總數確認檔方法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



<div align="center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-1439458814178865" data-ad-slot="2236653478"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">malagege</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">531</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">分類</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">425</span>
                  <span class="site-state-item-name">標籤</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/malagege" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#建立根憑證"><span class="nav-number">1.</span> <span class="nav-text">建立根憑證</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#產生中繼憑證"><span class="nav-number">2.</span> <span class="nav-text">產生中繼憑證</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#產生授權根憑證"><span class="nav-number">2.1.</span> <span class="nav-text">產生授權根憑證</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#產生中繼憑證-1"><span class="nav-number">2.2.</span> <span class="nav-text">產生中繼憑證</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#產生終端憑證"><span class="nav-number">2.3.</span> <span class="nav-text">產生終端憑證</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wildcard"><span class="nav-number">3.</span> <span class="nav-text">wildcard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TWCA-憑證為什麼有三層，四層串到同一個憑證呢"><span class="nav-number">4.</span> <span class="nav-text">TWCA 憑證為什麼有三層，四層串到同一個憑證呢?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#測試檔案"><span class="nav-number">5.</span> <span class="nav-text">測試檔案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看-web-上驗憑證內容"><span class="nav-number">6.</span> <span class="nav-text">查看 web 上驗憑證內容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他資源"><span class="nav-number">7.</span> <span class="nav-text">其他資源</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">malagege</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://malagege-blog.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://malagege.github.io/blog/2020/07/18/產生自簽憑證筆記/';
          this.page.identifier = '2020/07/18/產生自簽憑證筆記/';
          this.page.title = '產生自簽憑證筆記';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://malagege-blog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
