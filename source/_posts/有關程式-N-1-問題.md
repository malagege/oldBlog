---
title: 有關程式 N+1 問題
date: 2019-05-21 21:09:36
tags: [sql, orm]
categories: 程式心法
---

最近在做複雜的 API
由於 PM 覺得某一個 JSON 屬性調整
結果需要改好幾隻程式 API
不過有查到可以使用[GraphQL | 一种为你的 API 而生的查询语言](https://graphql.cn/)
但這篇不是重點在 GraphQL
而是我探索某一篇 [阻碍你使用 GraphQL 的十个问题 | 咀嚼之味](https://jerryzou.com/posts/10-questions-about-graphql/)

> 它就像是一顆無限向下延伸的樹。所以在我看來，GraphQL 更應該叫 TreeQL，當然在圖論裡，Tree 就是 Graph 也沒毛病啦。需要注意的是，這也會引出 「N + 1 problem」 的話題——naive 的 GraphQL 服務端實現會讓這段 query 變得異常慢！

看了一下內容，N+1 問題就有像一個查詢每一行執行 SQL
如下

```sql
SELECT * FROM `song` LIMIT 0, 20;
SELECT * FROM `singer` WHERE `id` = 1;
SELECT * FROM `singer` WHERE `id` = 2;
SELECT * FROM `singer` WHERE `id` = 3;
...
```

奇怪，這個怎麼讓我想到 ORM 也是這樣
所以我查了一下 ORM 真的也有這個問題
由於最近也想開使用 ORM ，所以進入前想了解之後使用上會遇到什麼問題
這邊只會先整理

<!--more-->

## DataLoader

目前查到資料可以用 `DataLoader` 方式解決問題

> Dataloader 主要有兩項功能： Batching (批次) & Caching (快取) 。
> Batching 在於他能夠將想要進 db 搜尋的 id 都搜集起來，等時間到了一次進 db 搜尋，解決 N + 1 問題。
> Caching 在於它在紀錄 id 時會做 memoization ，所以未來若是有重複的 id 進來就會被剔除，保證資料索取數越少越好。

[GraphQL Design: 使用 DataLoader 提升效能 ! - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天](https://ithelp.ithome.com.tw/articles/10207606)

有爬到這篇有 10000 一筆一筆方式撈出來
得到
[用範例程式實際探索 N + 1 query 有多可怕 – Yulin Chen – Medium](https://medium.com/@festime/%E7%94%A8%E7%AF%84%E4%BE%8B%E7%A8%8B%E5%BC%8F%E5%AF%A6%E9%9A%9B%E6%8E%A2%E7%B4%A2-n-1-query-%E6%9C%89%E5%A4%9A%E5%8F%AF%E6%80%95-b89e7735ea81)

## Laravel ORM 解決

> Laravel 中解決 N + 1 問題
> 使用預加載功能
> 使用 with() 方法，會做緩存
> with() 中放需要查詢的關聯屬性
> [總結要點：使用 Laravel 開發工具，ORM 查詢的 N + 1 問題 | Laravel China 社區 - 高品質的 Laravel 開發者社區](https://learnku.com/laravel/t/7778/summary-using-the-laravel-development-tool-the-n-1-problem-of-the-orm-query)

## 我自己想到的方法

由於 sharding 不能做 join 動作，所以我使用`where in (id list)`方式查詢
但這種方法程式一寫差錯，可能程式就`500`了

其中有一篇 Eager Loading，Laravel 的 `with` 跟這個有關係

- [ORM 中的 N+1 问题 - google4y - 博客园](https://www.cnblogs.com/google4y/p/3455534.html)
- [◉ Performance: N+1 Query Problem](https://secure.phabricator.com/book/phabcontrib/article/n_plus_one/)
- [GraphQL N+1 问题解决方案 | HHF 金字塔](http://www.haohongfan.com/2018/11/graphql-n-1-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/)
- [[Rails] N+1 Queries Problem – Dosmanthus – Medium](https://medium.com/@dd0425/rails-n-1-queries-problem-73dfe5f99182)
- [Eloquent: Relationships - Laravel - The PHP Framework For Web Artisans](https://laravel.com/docs/5.8/eloquent-relationships#eager-loading)
- [数据库:django ORM 如何处理 N+1 查询 - 答复哈 - OSCHINA](https://my.oschina.net/oncereply/blog/268922)

### 相關連結

- [Laravel 使用二级缓存提高缓存命中率和内存使用效率 - 探花的 Blog](http://vanry.me/laravel/secod-level-cache.html)
- [Laravel 在 with 查询中只查询个别字段 | Laravel China 社区 - 高品质的 Laravel 开发者社区](https://learnku.com/laravel/t/1220/laravel-queries-only-individual-fields-in-with-queries)
- [[擴展推薦] Laravel Query Detector 數據模型查詢的 N+1 問題捕殺神器 | Laravel China 社區 - 高品質的 Laravel 開發者社區](https://learnku.com/laravel/t/14691/extended-recommendation-n1-question-capture-artifact-for-laravel-query-detector-data-model-query)
- [在 Laravel 中使用 GraphQL 一【获取数据】 | Laravel China 社区 - 高品质的 Laravel 开发者社区](https://learnku.com/articles/8115/using-graphql-one-in-laravel-get-data)
- [阻礙你使用 GraphQL 的十個問題 | 咀嚼之味](https://jerryzou.com/posts/10-questions-about-graphql/)

## 其他小記

### GraphQL 小記

- [TypeORM - 最好的 Node.js ORM 框架 - CNode 技术社区](https://cnodejs.org/topic/5ac073b852d7d3a8698a49f4)
- [GraphQL 教程（六）—— N+1 问题和缓存等问题 | 豪翔天下](https://haofly.net/graphql-tutorial-6/)
- [Using DataLoader with GraphQL: A Concrete Example – codeburst](https://codeburst.io/using-dataloader-with-graphql-a-concrete-example-9b21352f1676)
- [在 Laravel 中使用 GraphQL 一【获取数据】 | Laravel China 社区 - 高品质的 Laravel 开发者社区](https://learnku.com/articles/8115/using-graphql-one-in-laravel-get-data)
- [GraphQL Design: 使用 DataLoader 提升效能 ! - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天](https://ithelp.ithome.com.tw/articles/10207606)
- [阻碍你使用 GraphQL 的十个问题 | 咀嚼之味](https://jerryzou.com/posts/10-questions-about-graphql/)
- [GraphQL 入門： 簡介 X 範例 X 優缺點 - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天](https://ithelp.ithome.com.tw/articles/10200678)
- [2018 GraphQL 漸進式導入的架構 – Michael Hsu – Medium](https://medium.com/@evenchange4/2018-graphql-%E6%BC%B8%E9%80%B2%E5%BC%8F%E5%B0%8E%E5%85%A5%E7%9A%84%E6%9E%B6%E6%A7%8B-aeb2603f2223)

### sharding 小記

> 當下還沒有非常令人滿意的基於 hibernate 的 sharding 框架，（關於 hibernate hards 會在下文介紹），因此很多團隊會選擇自行實現 sharding。

原文網址：https://read01.com/AJO2Bm.html

[Spring 的 DAO 支持](https://openhome.cc/Gossip/SpringGossip/SpringDAO.html)

### ftp 小記

因為最近沒時間整理
所以先暫時貼在這
目前可能組`put xxx`的 ftp 指令內容
最後在`sftp < xxx.txt`會比較快

- [List all files in a ftp folder in a text file [ bash ls ]](https://gist.github.com/timendum/1109055)
- [How to upload (FTP) files to server in a bash script? - Stack Overflow](https://stackoverflow.com/questions/1894347/how-to-upload-ftp-files-to-server-in-a-bash-script/1894479)
- [bash - Get notified about new files on SFTP server - Ask Ubuntu](https://askubuntu.com/questions/576927/get-notified-about-new-files-on-sftp-server)
- [用二句 Shell 命令实现 FTP 批量上传文件夹 - linux48](http://linux48.com/2014-11-11-shell-ftp-uplod.html)
- [Upload files from a list via ftp in bash - Stack Overflow](https://stackoverflow.com/questions/44019171/upload-files-from-a-list-via-ftp-in-bash)
